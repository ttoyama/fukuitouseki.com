name: Build booklet PDF

on:
  push:
    branches: [ main ]
    paths:
      - '.bookorder'
      - '**/*.md'
      - 'book/**'
      - '.github/workflows/booklet.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pandoc & TeX & fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-latex-recommended \
            texlive-fonts-recommended texlive-lang-cjk fonts-noto-cjk

      - name: Prepare ordered list
        id: order
        run: |
          # ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ç©ºè¡Œã‚’é™¤å»
          grep -v '^\s*#' .bookorder | sed '/^\s*$/d' > .bookorder.clean
          # è¡¨ç´™ã‚’å…ˆé ­ã«å·®ã—è¾¼ã‚€ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
          if [ -f book/cover.md ]; then
            printf 'book/cover.md\n' | cat - .bookorder.clean > .bookorder.with_cover
          else
            cp .bookorder.clean .bookorder.with_cover
          fi
          # å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          missing=0
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            if [ ! -f "$f" ]; then
              echo "::error file=.bookorder::æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $f"
              missing=1
            fi
          done < .bookorder.with_cover
          [ $missing -eq 0 ] || exit 1
          tr '\n' '\0' < .bookorder.with_cover > order.nul

      - name: Debug file order
        run: |
          echo "=== File order debug ==="
          cat .bookorder.with_cover
          echo "=== First file content check ==="
          head -10 "$(head -1 .bookorder.with_cover)"
          echo "=== All files content check ==="
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            echo "=== Content of: $file ==="
            head -3 "$file" || echo "Failed to read: $file"
          done < .bookorder.with_cover
          
      - name: Build complete booklet (Pandoc â†’ XeLaTeX)
        run: |
          mkdir -p pdfs
          
          # Try a different approach - use cat to combine files first
          echo "---" > combined.md
          echo "title: ç½å®³æ™‚é€æåŒ»ç™‚ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹å¼•ã" >> combined.md
          echo "author: ç¦äº•é€æãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœ¬éƒ¨" >> combined.md
          echo "lang: ja" >> combined.md
          echo "CJKmainfont: 'Noto Sans CJK JP'" >> combined.md
          echo "geometry: margin=20mm" >> combined.md
          echo "documentclass: article" >> combined.md
          echo "---" >> combined.md
          echo "" >> combined.md
          
          # Combine all files, stripping individual YAML frontmatters
          for file in book/cover.md "docs/00-å¹³æ™‚ã®æº–å‚™.md" "docs/01-åˆå‹•å¯¾å¿œ.md" "docs/02-æ–½è¨­åˆ¥å¯¾å¿œ.md" "docs/03-ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯èª¿æ•´.md" "docs/è³‡æ–™/è³‡æ–™_ç¦äº•çœŒå†…é€ææ–½è¨­ä¸€è¦§.md" "docs/è³‡æ–™/è³‡æ–™_é€ææ‚£è€…å‘ã‘é£Ÿå“æ „é¤Šæˆåˆ†è¡¨.md" "docs/è³‡æ–™/01-åˆå‹•å¯¾å¿œ_æ§˜å¼01_ç½å®³æ™‚é€æåŒ»ç™‚æ©Ÿé–¢çŠ¶æ³å ±å‘Šæ›¸_åˆå‹•å ±å‘Šç”¨.md" "docs/è³‡æ–™/01-åˆå‹•å¯¾å¿œ_ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ_01_0-30åˆ†.md" "docs/è³‡æ–™/01-åˆå‹•å¯¾å¿œ_ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ_02_1-3æ™‚é–“.md" "docs/è³‡æ–™/01-åˆå‹•å¯¾å¿œ_ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ_03_3-24æ™‚é–“.md"; do
            echo "" >> combined.md
            echo "\\newpage" >> combined.md
            echo "" >> combined.md
            # Skip YAML frontmatter and add content
            sed '1,/^---$/d; /^---$/,/^---$/d' "$file" >> combined.md
          done
          
          # Build PDF from combined file
          pandoc combined.md \
            --pdf-engine=xelatex \
            --toc \
            --toc-depth=2 \
            --number-sections \
            -o pdfs/fukuitouseki_booklet.pdf
          
          ls -lah pdfs

      - name: Commit and push PDF to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Copy PDF to a permanent location in the repo
          mkdir -p booklet-pdf
          cp pdfs/fukuitouseki_booklet.pdf booklet-pdf/
          
          # Add and commit if there are changes
          git add booklet-pdf/fukuitouseki_booklet.pdf
          if ! git diff --staged --quiet; then
            git commit -m "PDFç”Ÿæˆå®Œäº†: ç½å®³æ™‚é€æåŒ»ç™‚ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹å¼•ã

ğŸ¤– Generated with GitHub Actions"
            git push
            echo "PDF committed and pushed to repository"
          else
            echo "No changes to commit"
          fi

      - name: Upload artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: booklet-pdf
          path: pdfs/fukuitouseki_booklet.pdf